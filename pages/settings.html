<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings - ELITESTOCKOPTIONS</title>
  <link rel="icon" type="image/png" href="../public/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../public/js/supabase-config.js"></script>
  <script src="../public/js/supabase-client.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#7c3aed',
            accent: '#06b6d4'
          }
        }
      }
    }
  </script>
  <style>
    .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .sidebar-link { transition: all 0.3s ease; }
    .sidebar-link:hover, .sidebar-link.active {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
    }
    .tab-btn { transition: all 0.3s ease; }
    .tab-btn.active {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
    }
    .kyc-status-pending { background: #fef3c7; color: #92400e; }
    .kyc-status-verified { background: #d1fae5; color: #065f46; }
    .kyc-status-rejected { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-xl hidden lg:flex flex-col">
      <div class="p-6 border-b">
        <div class="flex items-center space-x-3">
          <img src="../public/logo.png" alt="ELITESTOCKOPTIONS" class="w-10 h-10 object-contain">
          <span class="font-bold text-lg text-gray-900">ELITESTOCK</span>
        </div>
      </div>
      <nav class="flex-1 overflow-y-auto py-4">
        <div class="px-4 mb-2 text-xs font-semibold text-gray-400 uppercase">Main</div>
        <a href="dashboard.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-home w-5"></i><span>Dashboard</span>
        </a>
        <a href="markets.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-chart-bar w-5"></i><span>Markets</span>
        </a>
        <a href="my-trades.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-exchange-alt w-5"></i><span>My Trades</span>
        </a>
        <div class="px-4 mt-6 mb-2 text-xs font-semibold text-gray-400 uppercase">Finance</div>
        <a href="deposit.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-arrow-down w-5"></i><span>Deposit</span>
        </a>
        <a href="withdrawal.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-arrow-up w-5"></i><span>Withdraw</span>
        </a>
        <a href="transactions.html" class="sidebar-link flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl text-gray-600">
          <i class="fas fa-list w-5"></i><span>Transactions</span>
        </a>
        <div class="px-4 mt-6 mb-2 text-xs font-semibold text-gray-400 uppercase">Account</div>
        <a href="settings.html" class="sidebar-link active flex items-center space-x-3 px-4 py-3 mx-2 rounded-xl">
          <i class="fas fa-cog w-5"></i><span>Settings</span>
        </a>
      </nav>
      <div class="p-4 border-t">
        <button onclick="logout()" class="flex items-center space-x-3 px-4 py-3 w-full rounded-xl text-red-600 hover:bg-red-50 transition-colors">
          <i class="fas fa-sign-out-alt w-5"></i><span>Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="flex items-center justify-between px-6 py-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
            <p class="text-gray-500 text-sm">Manage your account preferences</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="w-10 h-10 gradient-bg rounded-full flex items-center justify-center text-white font-bold" id="userAvatar">T</div>
          </div>
        </div>
      </header>

      <div class="p-6">
        <!-- Settings Tabs -->
        <div class="flex space-x-2 mb-6 overflow-x-auto">
          <button onclick="switchTab('profile')" id="tab-profile" class="tab-btn active px-6 py-2 rounded-xl font-medium">Profile</button>
          <button onclick="switchTab('security')" id="tab-security" class="tab-btn px-6 py-2 rounded-xl font-medium text-gray-600 hover:bg-gray-100">Security</button>
          <button onclick="switchTab('kyc')" id="tab-kyc" class="tab-btn px-6 py-2 rounded-xl font-medium text-gray-600 hover:bg-gray-100">KYC Verification</button>
          <button onclick="switchTab('notifications')" id="tab-notifications" class="tab-btn px-6 py-2 rounded-xl font-medium text-gray-600 hover:bg-gray-100">Notifications</button>
        </div>

        <!-- Profile Tab -->
        <div id="content-profile" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">Profile Information</h2>
          <form id="profileForm" class="space-y-6 max-w-2xl">
            <div class="flex items-center space-x-6 mb-6">
              <img src="" alt="Profile" class="w-24 h-24 rounded-full object-cover bg-gradient-to-br from-primary to-secondary" id="profileAvatarImg">
              <div>
                <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="handleProfilePhotoChange(event)">
                <button type="button" onclick="document.getElementById('profilePhotoInput').click()" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200 transition-colors">
                  <i class="fas fa-camera mr-2"></i>Change Photo
                </button>
                <p class="text-sm text-gray-500 mt-2">JPG, PNG or GIF. Max 2MB.</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input type="text" id="profileName" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input type="email" id="profileEmail" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20" readonly>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                <input type="tel" id="profilePhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                <select id="profileCountry" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20">
                  <option value="US">United States</option>
                  <option value="UK">United Kingdom</option>
                  <option value="CA">Canada</option>
                  <option value="AU">Australia</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition-opacity">
              <i class="fas fa-save mr-2"></i>Save Changes
            </button>
          </form>
        </div>

        <!-- Security Tab -->
        <div id="content-security" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">Security Settings</h2>
          <div class="space-y-6 max-w-2xl">
            <div class="p-4 border border-gray-200 rounded-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold text-gray-900">Change Password</h3>
                  <p class="text-sm text-gray-500">Update your account password</p>
                </div>
                <button onclick="togglePasswordForm()" class="text-primary font-medium">Change</button>
              </div>
              <form id="passwordForm" class="hidden mt-4 space-y-4">
                <input type="password" id="currentPassword" placeholder="Current Password" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                <input type="password" id="newPassword" placeholder="New Password" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required>
                <button type="submit" class="gradient-bg text-white px-4 py-2 rounded-lg">Update Password</button>
              </form>
            </div>
            <div class="p-4 border border-gray-200 rounded-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold text-gray-900">Two-Factor Authentication</h3>
                  <p class="text-sm text-gray-500">Add an extra layer of security</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
            <div class="p-4 border border-gray-200 rounded-xl">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold text-gray-900">Login Notifications</h3>
                  <p class="text-sm text-gray-500">Get notified of new logins</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" checked class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- KYC Tab -->
        <div id="content-kyc" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">KYC Verification</h2>
          <div id="kycStatusSection" class="mb-6">
            <div class="flex items-center space-x-4 p-4 rounded-xl" id="kycStatusBanner">
              <i class="fas fa-clock text-2xl"></i>
              <div>
                <p class="font-semibold">Verification Status: <span id="kycStatusText">Pending</span></p>
                <p class="text-sm" id="kycStatusDesc">Your documents are under review</p>
              </div>
            </div>
          </div>
          <form id="kycForm" class="space-y-6 max-w-2xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">First Name (as on ID)</label>
                <input type="text" id="kycFirstName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name (as on ID)</label>
                <input type="text" id="kycLastName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                <input type="date" id="kycDob" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ID Type</label>
                <select id="kycIdType" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary">
                  <option value="">Select ID Type</option>
                  <option value="passport">Passport</option>
                  <option value="drivers_license">Driver's License</option>
                  <option value="national_id">National ID</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ID Number</label>
              <input type="text" id="kycIdNumber" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Front of ID</label>
                <input type="file" id="kycFrontInput" accept="image/*" class="hidden" onchange="handleKycFileChange(event, 'front')">
                <div onclick="document.getElementById('kycFrontInput').click()" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition-colors cursor-pointer" id="kycFrontPreview">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2" id="kycFrontIcon"></i>
                  <img src="" alt="ID Front" class="hidden w-full h-32 object-contain rounded-lg" id="kycFrontImg">
                  <p class="text-sm text-gray-500" id="kycFrontText">Click to upload or drag and drop</p>
                  <p class="text-xs text-gray-400 mt-1">PNG, JPG up to 5MB</p>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Back of ID</label>
                <input type="file" id="kycBackInput" accept="image/*" class="hidden" onchange="handleKycFileChange(event, 'back')">
                <div onclick="document.getElementById('kycBackInput').click()" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition-colors cursor-pointer" id="kycBackPreview">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2" id="kycBackIcon"></i>
                  <img src="" alt="ID Back" class="hidden w-full h-32 object-contain rounded-lg" id="kycBackImg">
                  <p class="text-sm text-gray-500" id="kycBackText">Click to upload or drag and drop</p>
                  <p class="text-xs text-gray-400 mt-1">PNG, JPG up to 5MB</p>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Selfie with ID</label>
              <input type="file" id="kycSelfieInput" accept="image/*" class="hidden" onchange="handleKycFileChange(event, 'selfie')">
              <div onclick="document.getElementById('kycSelfieInput').click()" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-primary transition-colors cursor-pointer" id="kycSelfiePreview">
                <i class="fas fa-camera text-3xl text-gray-400 mb-2" id="kycSelfieIcon"></i>
                <img src="" alt="Selfie" class="hidden w-full h-32 object-contain rounded-lg" id="kycSelfieImg">
                <p class="text-sm text-gray-500" id="kycSelfieText">Take a selfie holding your ID</p>
                <p class="text-xs text-gray-400 mt-1">Make sure your face and ID are clearly visible</p>
              </div>
            </div>
            <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition-opacity">
              <i class="fas fa-paper-plane mr-2"></i>Submit for Verification
            </button>
          </form>
        </div>

        <!-- Notifications Tab -->
        <div id="content-notifications" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-bold text-gray-900 mb-6">Notification Preferences</h2>
          <div class="space-y-4 max-w-2xl">
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl">
              <div>
                <h3 class="font-semibold text-gray-900">Trade Notifications</h3>
                <p class="text-sm text-gray-500">Get notified when trades are executed</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" checked class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl">
              <div>
                <h3 class="font-semibold text-gray-900">Price Alerts</h3>
                <p class="text-sm text-gray-500">Notifications for price movements</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" checked class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl">
              <div>
                <h3 class="font-semibold text-gray-900">Deposit/Withdrawal</h3>
                <p class="text-sm text-gray-500">Transaction confirmations</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" checked class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-xl">
              <div>
                <h3 class="font-semibold text-gray-900">Marketing Emails</h3>
                <p class="text-sm text-gray-500">Promotions and updates</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentUser = JSON.parse(localStorage.getItem('elitestockoptions_user') || localStorage.getItem('eso_currentUser'));

    // Sync balance from shared users storage (new + legacy keys)
    const allUsers = JSON.parse(localStorage.getItem('elitestockoptions_users') || localStorage.getItem('eso_users') || '[]');
    const serverUser = allUsers.find(u => u.id === currentUser.id);
    if (serverUser) {
      currentUser.balance = serverUser.balance || 0;
      currentUser.availableCash = serverUser.availableCash || 0;
      currentUser.profitsBalance = serverUser.profitsBalance || 0;
      localStorage.setItem('elitestockoptions_user', JSON.stringify(currentUser));
    }
    if (!currentUser) {
      alert('Please login first');
      window.location.href = 'login.html';
    }

    function getSharedUsers() {
      return JSON.parse(localStorage.getItem('elitestockoptions_users') || localStorage.getItem('eso_users') || '[]');
    }

    function saveSharedUsers(users) {
      localStorage.setItem('elitestockoptions_users', JSON.stringify(users));
      localStorage.setItem('eso_users', JSON.stringify(users));
    }

    // Store KYC files temporarily before submission
    let kycFiles = { front: null, back: null, selfie: null };

    function initSettings() {
      // Update avatars
      const avatarUrl = currentUser.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.fullName || currentUser.email}&backgroundColor=b6e3f4`;
      document.getElementById('userAvatar').innerHTML = `<img src="${avatarUrl}" alt="Avatar" class="w-10 h-10 rounded-full">`;
      document.getElementById('profileAvatarImg').src = currentUser.profilePhoto || avatarUrl;
      
      document.getElementById('profileName').value = currentUser.fullName || '';
      document.getElementById('profileEmail').value = currentUser.email || '';
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileCountry').value = currentUser.country || 'US';
      
      // Load existing KYC data if available
      if (currentUser.kycData) {
        document.getElementById('kycFirstName').value = currentUser.kycData.firstName || '';
        document.getElementById('kycLastName').value = currentUser.kycData.lastName || '';
        document.getElementById('kycDob').value = currentUser.kycData.dob || '';
        document.getElementById('kycIdType').value = currentUser.kycData.idType || '';
        document.getElementById('kycIdNumber').value = currentUser.kycData.idNumber || '';
        
        // Load existing KYC images
        if (currentUser.kycDocuments?.front) {
          showKycPreview('front', currentUser.kycDocuments.front);
        }
        if (currentUser.kycDocuments?.back) {
          showKycPreview('back', currentUser.kycDocuments.back);
        }
        if (currentUser.kycDocuments?.selfie) {
          showKycPreview('selfie', currentUser.kycDocuments.selfie);
        }
      }
      
      updateKycStatus();
    }

    function handleProfilePhotoChange(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 2 * 1024 * 1024) {
        alert('File size must be less than 2MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        currentUser.profilePhoto = e.target.result;
        localStorage.setItem('elitestockoptions_user', JSON.stringify(currentUser));
        document.getElementById('profileAvatarImg').src = e.target.result;
        
        // Update in shared users storage as well
        let users = getSharedUsers();
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        if (userIndex >= 0) {
          users[userIndex].profilePhoto = e.target.result;
          saveSharedUsers(users);
        }
        
        alert('Profile photo updated!');
      };
      reader.readAsDataURL(file);
    }

    function handleKycFileChange(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('File size must be less than 5MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        kycFiles[type] = e.target.result;
        showKycPreview(type, e.target.result);
      };
      reader.readAsDataURL(file);
    }

    function showKycPreview(type, imageData) {
      document.getElementById(`kyc${type.charAt(0).toUpperCase() + type.slice(1)}Icon`).classList.add('hidden');
      document.getElementById(`kyc${type.charAt(0).toUpperCase() + type.slice(1)}Text`).textContent = 'Click to change image';
      const img = document.getElementById(`kyc${type.charAt(0).toUpperCase() + type.slice(1)}Img`);
      img.src = imageData;
      img.classList.remove('hidden');
    }

    function updateKycStatus() {
      const status = currentUser.kycStatus || 'pending';
      const banner = document.getElementById('kycStatusBanner');
      const text = document.getElementById('kycStatusText');
      const desc = document.getElementById('kycStatusDesc');
      
      banner.className = 'flex items-center space-x-4 p-4 rounded-xl ';
      if (status === 'verified') {
        banner.classList.add('kyc-status-verified');
        text.textContent = 'Verified';
        desc.textContent = 'Your identity has been verified';
        document.getElementById('kycForm').classList.add('hidden');
      } else if (status === 'rejected') {
        banner.classList.add('kyc-status-rejected');
        text.textContent = 'Rejected';
        desc.textContent = 'Please resubmit your documents';
      } else {
        banner.classList.add('kyc-status-pending');
        text.textContent = 'Pending';
        desc.textContent = 'Your documents are under review';
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-600');
      });
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('tab-' + tab).classList.remove('text-gray-600');
      
      document.querySelectorAll('[id^="content-"]').forEach(content => content.classList.add('hidden'));
      document.getElementById('content-' + tab).classList.remove('hidden');
    }

    function togglePasswordForm() {
      document.getElementById('passwordForm').classList.toggle('hidden');
    }

    document.getElementById('profileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      currentUser.fullName = document.getElementById('profileName').value;
      currentUser.phone = document.getElementById('profilePhone').value;
      currentUser.country = document.getElementById('profileCountry').value;
      localStorage.setItem('elitestockoptions_user', JSON.stringify(currentUser));

      let users = getSharedUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex >= 0) {
        users[userIndex].fullName = currentUser.fullName;
        users[userIndex].phone = currentUser.phone;
        users[userIndex].country = currentUser.country;
        saveSharedUsers(users);
      }

      alert('Profile updated successfully!');
    });

    document.getElementById('kycForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Check if all documents are uploaded
      if (!kycFiles.front && !currentUser.kycDocuments?.front) {
        alert('Please upload the front of your ID');
        return;
      }
      if (!kycFiles.back && !currentUser.kycDocuments?.back) {
        alert('Please upload the back of your ID');
        return;
      }
      if (!kycFiles.selfie && !currentUser.kycDocuments?.selfie) {
        alert('Please upload a selfie with your ID');
        return;
      }
      
      currentUser.kycStatus = 'pending';
      currentUser.kycSubmittedAt = new Date().toISOString();
      currentUser.kycData = {
        firstName: document.getElementById('kycFirstName').value,
        lastName: document.getElementById('kycLastName').value,
        dob: document.getElementById('kycDob').value,
        idType: document.getElementById('kycIdType').value,
        idNumber: document.getElementById('kycIdNumber').value
      };
      
      // Store KYC documents
      currentUser.kycDocuments = {
        front: kycFiles.front || currentUser.kycDocuments?.front,
        back: kycFiles.back || currentUser.kycDocuments?.back,
        selfie: kycFiles.selfie || currentUser.kycDocuments?.selfie
      };
      
      localStorage.setItem('elitestockoptions_user', JSON.stringify(currentUser));
      
      // Update in shared users storage for admin access
      let users = getSharedUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex >= 0) {
        users[userIndex].kycStatus = 'pending';
        users[userIndex].kycSubmittedAt = currentUser.kycSubmittedAt;
        users[userIndex].kycData = currentUser.kycData;
        users[userIndex].kycDocuments = currentUser.kycDocuments;
        saveSharedUsers(users);
      }
      
      updateKycStatus();
      alert('KYC documents submitted for review!');
    });

    // Password change handler
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPwd = document.getElementById('currentPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirmPwd = document.getElementById('confirmPassword').value;

      const supabaseReady = !!(window.ESO_DB && window.ESO_DB.isReady());
      if (!supabaseReady && currentPwd !== currentUser.password) {
        alert('Current password is incorrect');
        return;
      }
      
      // Check new password length
      if (newPwd.length < 6) {
        alert('New password must be at least 6 characters');
        return;
      }
      
      // Confirm passwords match
      if (newPwd !== confirmPwd) {
        alert('New passwords do not match');
        return;
      }
      
      if (supabaseReady) {
        const updated = await window.ESO_DB.updatePassword(newPwd);
        if (!updated) {
          alert('Could not update password right now. Please try again.');
          return;
        }
      }

      // Update local fallback password
      currentUser.password = newPwd;
      localStorage.setItem('elitestockoptions_user', JSON.stringify(currentUser));
      
      // Update in shared users storage
      let users = getSharedUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex >= 0) {
        users[userIndex].password = newPwd;
        saveSharedUsers(users);
      }
      
      alert('Password updated successfully!');
      document.getElementById('passwordForm').reset();
      document.getElementById('passwordForm').classList.add('hidden');
    });

    function logout() {
      localStorage.removeItem('elitestockoptions_user');
      window.location.href = '../index.html';
    }

    initSettings();
  </script>
<script src="../public/js/back-button.js"></script>
<script src="../public/js/smartsupp.js?v=20260219-7"></script>
<script src="../public/js/theme.js"></script>
</body>
</html>
